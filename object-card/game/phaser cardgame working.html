<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Making your first Phaser 3 Game - Part 1</title>
  <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
  <style type="text/css">
    body {
      margin: 0;
    }
  </style>
</head>

<body>

  <script type="text/javascript">

    var config = {
      type: Phaser.AUTO,
      width: 1600,
      height: 800,
      scene: {
        preload: preload,
        create: create,
        update: update
      }
    };

    var p2_card = {
      COST: 0,
      HP: 0,
      ATK: 0,
      TYPE:"SLIME"
    };

    var p1_card =[];
    var p2_card =[];

    //ff_cardはバフするときの途中に使うやつ
    var ff_card={1:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},2:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},3:{HP:1,ATK:1,TYPE:"SLIME",NAME:""}};
    var p2_ff_card={1:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},2:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},3:{HP:1,ATK:1,TYPE:"SLIME",NAME:""}};
    
    //instans_cardは最後のインスタン化するときのやつ
    var instans_card={1:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},2:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},3:{HP:1,ATK:1,TYPE:"SLIME",NAME:""}};
    var p2_instans_card={1:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},2:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},3:{HP:1,ATK:1,TYPE:"SLIME",NAME:""}};

    var obj_card=new Object();
    var copy_card={1:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},2:{HP:1,ATK:1,TYPE:"SLIME",NAME:""},3:{HP:1,ATK:1,TYPE:"SLIME",NAME:""}};


    var game = new Phaser.Game(config);
    var hand = 5;
    var deck = 30;
    var HP = 10;
    var HPText;
    var set = null;
    var SCText;
    var WINText;
    var width = 1600;
    var height = 800;
    var cards = [];
    var hands = [];
    var dug = hand;
    var p1 = 1;
    var p2 = 2;
    var field_card = [];
    var p2_field_card = [];
    var damage12 = 0;//1to2damage いらん？
    var damage21 = 0;//2to1damage　いらん？
    var p_turn = 1;//1ならp1 0ならp2
    var atack = 1;//1ならアタック0ならディフェンス
    var count1 = 0;//p1
    var count2 = 0;//p2
    var wins = 0;//
    var ErrorText;
    var c=0;
    var STAT_TEXT=[];
    var TYPE_TEXT=[];
    var end_fin=0;//お互いがend押したかどうか0か1
    var ready_flag=0;//ready押したかどうか
    var setnum="";//どれをインスタンス化するかの数値
    var hand_num=0;//手札の何枚目を場に出したかがわかる数値
    var end_count=0;


    function getUrlVars() {
      var vars = [], max = 0, hash = "", array = "";
      var url = window.location.search;

      //?を取り除くため、1から始める。複数のクエリ文字列に対応するため、&で区切る
      hash = url.slice(1).split('&');
      max = hash.length;
      for (var i = 0; i < max; i++) {
        array = hash[i].split('=');    //keyと値に分割。
        vars.push(array[0]);    //末尾にクエリ文字列のkeyを挿入。
        vars[array[0]] = array[1];    //先ほど確保したkeyに、値を代入。
      }

      return vars;
    }


    var val = getUrlVars();
    console.log(val.player);
    var p2_HP=10;



    function preload() {
      this.load.image('card', '/object-cardgame/game/img/card.png');
      this.load.image('card2', '/object-cardgame/game/img/card2.png');
      this.load.image('cardc01', '/object-cardgame/game/img/c01.png');
      this.load.image('cardc02', '/object-cardgame/game/img/c02.png');
      this.load.image('cardc03', '/object-cardgame/game/img/c03.png');
      this.load.image('cardc04', '/object-cardgame/game/img/c04.png');
      this.load.image('cardc05', '/object-cardgame/game/img/c05.png');
      this.load.image('cardc06', '/object-cardgame/game/img/c06.png');
      this.load.image('cardc07', '/object-cardgame/game/img/c07.png');
      this.load.image('cardc08', '/object-cardgame/game/img/c08.png');
      this.load.image('cardc09', '/object-cardgame/game/img/c09.png');
      this.load.image('cardc10', '/object-cardgame/game/img/c10.png');
      this.load.image('cardc11', '/object-cardgame/game/img/c11.png');
      this.load.image('cardc12', '/object-cardgame/game/img/c12.png');
      this.load.image('cardc13', '/object-cardgame/game/img/c13.png');
      this.load.image('cardd01', '/object-cardgame/game/img/d01.png');
      this.load.image('cardd02', '/object-cardgame/game/img/d02.png');
      this.load.image('cardd03', '/object-cardgame/game/img/d03.png');
      this.load.image('cardd04', '/object-cardgame/game/img/d04.png');
      this.load.image('cardd05', '/object-cardgame/game/img/d05.png');
      this.load.image('cardd06', '/object-cardgame/game/img/d06.png');
      this.load.image('cardd07', '/object-cardgame/game/img/d07.png');
      this.load.image('cardd08', '/object-cardgame/game/img/d08.png');
      this.load.image('cardd09', '/object-cardgame/game/img/d09.png');
      this.load.image('cardd10', '/object-cardgame/game/img/d10.png');
      this.load.image('cardd11', '/object-cardgame/game/img/d11.png');
      this.load.image('cardd12', '/object-cardgame/game/img/d12.png');
      this.load.image('cardd13', '/object-cardgame/game/img/d13.png');
      this.load.image('cardh01', '/object-cardgame/game/img/h01.png');
      this.load.image('cardh02', '/object-cardgame/game/img/h02.png');
      this.load.image('cardh03', '/object-cardgame/game/img/h03.png');
      this.load.image('cardh04', '/object-cardgame/game/img/h04.png');
      this.load.image('cardh05', '/object-cardgame/game/img/h05.png');
      this.load.image('cardh06', '/object-cardgame/game/img/h06.png');
      this.load.image('cardh07', '/object-cardgame/game/img/h07.png');
      this.load.image('cardh08', '/object-cardgame/game/img/h08.png');
      this.load.image('cardh09', '/object-cardgame/game/img/h09.png');
      this.load.image('cardh10', '/object-cardgame/game/img/h10.png');
      this.load.image('cardh11', '/object-cardgame/game/img/h11.png');
      this.load.image('cardh12', '/object-cardgame/game/img/h12.png');
      this.load.image('cardh13', '/object-cardgame/game/img/h13.png');
      this.load.image('cards01', '/object-cardgame/game/img/s01.png');
      this.load.image('cards02', '/object-cardgame/game/img/s02.png');
      this.load.image('cards03', '/object-cardgame/game/img/s03.png');
      this.load.image('cards04', '/object-cardgame/game/img/s04.png');
      this.load.image('cards05', '/object-cardgame/game/img/s05.png');
      this.load.image('cards06', '/object-cardgame/game/img/s06.png');
      this.load.image('cards07', '/object-cardgame/game/img/s07.png');
      this.load.image('cards08', '/object-cardgame/game/img/s08.png');
      this.load.image('cards09', '/object-cardgame/game/img/s09.png');
      this.load.image('cards10', '/object-cardgame/game/img/s10.png');
      this.load.image('cards11', '/object-cardgame/game/img/s11.png');
      this.load.image('cards12', '/object-cardgame/game/img/s12.png');
      this.load.image('cards13', '/object-cardgame/game/img/s13.png');
      this.load.image('slimc11', '/object-cardgame/game/img/slime.png');
      this.load.image('magic11', '/object-cardgame/game/img/mag.png');
      this.load.image('phsic11', '/object-cardgame/game/img/phs.png');
      this.load.image('flyic11', '/object-cardgame/game/img/fly.png');
      this.load.image('toric11', '/object-cardgame/game/img/tori.png');



    }

    function copy_array(c1, c2) {
        for (var i = 1; i <= 5; i++) {
          c1[i] = c2[i];
        }
    }//前のやつに後ろのやつを入れる

    function create() {

      var x = 0;

      for (var i = 1; i <= 9; i++) {
        cards[x] = 'cardc0' + i;
        x++;
        cards[x] = 'cardd0' + i;
        x++;
        cards[x] = 'cardh0' + i;
        x++;
        cards[x] = 'cards0' + i;
        x++;
      }//make deck1

      for (var i = 10; i <= 13; i++) {
        cards[x] = 'cardc' + i;
        x++;
        cards[x] = 'cardd' + i;
        x++;
        cards[x] = 'cardh' + i;
        x++;
        cards[x] = 'cards' + i;
        x++;
      }//make deck2

      for (i = 0; i < 53; i++) {
        r = Math.floor(Math.random() * 13 * 4);
        w = cards[i];
        cards[i] = cards[r];
        cards[r] = w;
      }//shuffle

      for (var i = 1; i <= hand; i++) {
        val.player
        hands[i] = cards[i];
        p2_field_card[i] = hands[i];//デバッグ
        card = this.add.image(-20 + i * 120, height / 8, hands[i]);
        deck = this.add.image(700, height / 8 * 2, 'card');
      }//p2 hand top

      text = this.add.text(680, 150, '山札');


      for (var i = 1; i <= hand; i++) {
        card = this.add.image(-20 + i * 120, height / 8 * 7, hands[i]);
        deck = this.add.image(700, height / 8 * 6, 'card');
      }//p1 hand under

      text = this.add.text(680, 550, '山札');

      var json_hand = {
        "player": "yoko",
        "field_card": []
      };//宣言

      for(var i=1;i<=3;i++){
        STAT_TEXT[i] = this.add.text(80 + i * 120, 450, "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
        TYPE_TEXT[i] = this.add.text(80 + i * 120-25, 325, "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
      }

      

      
      for(i=1;i<=3;i++){
        field_card[i]='slimc11';
        STAT_TEXT[i].setText(ff_card[i].HP+":"+ff_card[i].ATK);
        TYPE_TEXT[i].setText(ff_card[i].TYPE);
      }
      
      
      SCText = this.add.text(300, 550, 'SET:' + set).setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
      p2_HPText = this.add.text(650, 300, '2P HP:' + p2_HP).setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();      
      HPText = this.add.text(650, 450, '1P HP:' + HP).setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
      WINText = this.add.text(450, 250, 'WL').setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
      ErrorText = this.add.text(300, 600, 'E').setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
      instanText = this.add.text(100, 500, '').setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
    }

    function buff_hand() {
      var str1 = '' + hands[hand_num];
      p2_card.COST = Number(str1.slice(4, 5));
      if (str1.slice(4, 5) == 'c') {
        p2_card.ATK = 1;
      } else if (str1.slice(4, 5) == 'd') {
        p2_card.ATK = 2;
      } else if (str1.slice(4, 5) == 's') {
        p2_card.ATK = 3;
      } else if (str1.slice(4, 5) == 'h') {
        p2_card.ATK = 4;
      }
      p2_card.HP = Number(str1.slice(6, 7));
    }


    function result(count1, count2) {
      if (count2>count1) {
        if (wins >= 1) {
          wins++;
          WINText.setText('WINS:' + wins);
        } else {
          wins = 1;
          WINText.setText('WIN');
        }
        p2_HP--;
        if(p2_HP==1){
          ErrorText.setText('YOU WIN');
          
        }
      } else if (count1>count2) {
        WINText.setText('LOSE');
        if (HP == 1) {
          ErrorText.setText('YOU LOSE');
          
        }
        HP -= 1;

      } else {
        WINText.setText('Draw');
      }
      HPText.setText('1P HP' + HP);
      p2_HPText.setText('2P HP'+p2_HP);
    }

    
    function duel_old(f, p2_f) {
      var cnum=0;
      while ((count1 != 2  && count2 != 2)&& cnum++ != 10) {
        var r1 = Math.floor(Math.random() * 3 + 1);
        if (f[r1] != null) {
          var r2 = Math.floor(Math.random() * 3 + 1);
          if (p2_f[r2] != null) {
            console.log(f[r1].NAME+"VS"+p2_f[r2].NAME);
            f[r1].HP-=p2_f[r2].ATK;
            p2_f[r2].HP-=f[r1].ATK;

            if (f[r1].HP <= 0) {
              f[r1] = null;
              count1++;//カードが倒された
            } 
            if (p2_f[r2].HP <= 0) {
              p2_f[r2] = null;
              count2++;//カードが倒された
            } 
          }
        }
        console.log('count1:' + count1);
        console.log('count2:' + count2);
      }
      result(count1, count2);
      if (p_turn == 1) {
        p_turn = 0;//
      } else {
        p_turn = 1;//
      }//攻守交替最初に殴るのがどっちか

    }//p1からp2への戦い一方的

    function duel(f, p2_f) {
      var cnum=0;
      while ((count1 != 3  && count2 != 3)&& cnum++ != 20) {
        var r1 = Math.floor(Math.random() * 3 + 1);
        var r2 = Math.floor(Math.random() * 3 + 1);
        if (f[r1] != null && p2_f[r2] != null) {
            console.log("f["+r1+"]"+"VS"+"p2_f["+r2+"]");
            f[r1].HP-=p2_f[r2].ATK;
            p2_f[r2].HP-=f[r1].ATK;

            if (f[r1].HP <= 0) {
              f[r1] = null;
              count1++;//カードが倒された
            } 
            if (p2_f[r2].HP <= 0) {
              p2_f[r2] = null;
              count2++;//カードが倒された
            } 
        }
        console.log('count1:' + count1);
        console.log('count2:' + count2);
      }
      result(count1, count2);
      if (p_turn == 1) {
        p_turn = 0;//
      } else {
        p_turn = 1;//
      }//攻守交替最初に殴るのがどっちか
    }//p1からp2への戦い一方的
    

      function buff(){
        buff_hand(hands,set);
        console.log("hands:"+hands[set]);
        var b=p2_card;//足した奴
        console.log(b);
        console.log("もとのやつ:"+ff_card[set].ATK+","+ff_card[set].HP);
        console.log("足した奴:"+b.ATK+","+b.HP);
        ff_card[set].NAME=""+field_card[set];
        ff_card[set].ATK=ff_card[set].ATK+b.ATK;
        ff_card[set].HP=ff_card[set].HP+b.HP;
        console.log("ATK合計:"+ff_card[set].ATK);
        console.log("NAME合計:"+ff_card[set].NAME);
        console.log("HP合計:"+ff_card[set].HP);
      }

    function update() {
      let draw = this.add.text(800, 400, 'Draw').setFontSize(30).setFontFamily("Arial").setOrigin(0.5).setInteractive();
      let end = this.add.text(700, 400, 'End').setFontSize(30).setFontFamily("Arial").setOrigin(0.5).setInteractive();
      let ref = this.add.text(900, 400, 'Ref').setFontSize(30).setFontFamily("Arial").setOrigin(0.5).setInteractive();
      let START = this.add.text(300, 300, 'START').setFontSize(30).setFontFamily("Arial").setOrigin(0.5).setInteractive();
      let ready = this.add.text(150, 300, 'READY').setFontSize(30).setFontFamily("Arial").setOrigin(0.5).setInteractive();
      let card1 = this.add.image(100, height / 8 * 7, hands[1]).setOrigin(0.5).setInteractive();
      let card2 = this.add.image(220, height / 8 * 7, hands[2]).setOrigin(0.5).setInteractive();
      let card3 = this.add.image(340, height / 8 * 7, hands[3]).setOrigin(0.5).setInteractive();
      let card4 = this.add.image(460, height / 8 * 7, hands[4]).setOrigin(0.5).setInteractive();
      let card5 = this.add.image(580, height / 8 * 7, hands[5]).setOrigin(0.5).setInteractive();
      let slime1 = this.add.image(-20 + 2 * 120, height / 2, field_card[1]).setInteractive();
      let slime2 = this.add.image(-20 + 3 * 120, height / 2, field_card[2]).setInteractive();
      let slime3 = this.add.image(-20 + 4 * 120, height / 2, field_card[3]).setInteractive();
      SCText.setText('SET:' + set);//出したいカードの場所テキスト


      function status_card(set,ff_card){
        
      }//手札のカードの値をカードの下に表示する？？

      function updatehands(hands, hand, j) {
        for (var i = j; i <= hand; i++) {
          hands[i] = hands[i + 1];
        }
        hands[hand + 1] = null;
        STAT_TEXT[set].setText(ff_card[set].HP+":"+ff_card[set].ATK);
        TYPE_TEXT[set].setText(ff_card[set].TYPE);
      }//手札の順番ソート

      function updatefield(field_card, j) {
        for (var i = j; i <= hand; i++) {
          field_card[i] = field_card[i + 1];
        }
        field_card[j] = null;
      }//手札の順番ソート

      function array_check(c1) {
        for (var i = 2; i <= 4; i++) {
          if (c1[i].NAME == null) {
            return true;
          }
        }
        return false;
      }

      START.on('pointerdown', function (pointer) {
        //insertHandno(field_card);

        //この関数引数に配列足したほうがいいかも

        copy_array(field_card, hands);
        for (var i = 1; i <= 5; i++) {
          card2 = this.add.image(-20 + i * 120, height / 2, field_card[i]);
        }//手札すぐにセットするようのボタン
        console.log(field_card);

      }, this);

      ready.on('pointerdown', function (pointer) {
        instanText.setText("どれを戦闘に参加させますか？(インスタンス化)");
        ErrorText.setText("順番:"+setnum);
        ready_flag=1;
      }, this);

      function endc(po){
        updatehand(po);
      }

      function instans(str){
        copy_array(copy_card,ff_card);
        for(var i=2;i<=6;i=i+2){
          instans_card[i]=ff_card[str.slice(i-1,i)];
          console.log("strslice"+i+":"+str.slice(i-1,i));
        }
        
        //console.log("instans:"+instans_card[2].HP);
        console.log("ff_card:"+ff_card[2].HP);
      }

      function print(){
        for(i=1;i<=3;i++){
        console.log("f1["+i+":"+ff_card[i].HP+":"+ff_card[i].ATK);
        console.log("f2["+i+":"+p2_ff_card[i].HP+":"+p2_ff_card[i].ATK);
        }
      }

      end.on('pointerdown', function (pointer) {
        console.log("end key" + p_turn);
        console.log("end:"+field_card);
        print();
        console.log("**********end"+end_count++);
        if(ready_flag==0){
          ErrorText.setText("READYを押してインスタンス化してください");
        } else {
          //var rndm = Math.floor(Math.random() * 2);
          instans(setnum);
          console.log("instans_card:"+instans_card);
          //copy_array(copy_card,ff_card);
          console.log("p2" + p2_field_card);
          console.log("p1" + instans_card);
          //DBと更新DB上の値が２になるまで待つ関数？
          //ここで相手の場札のカードをp2_field_cardに入れる
          //**insertHandno(hands, "" + val.player, 1);
          
          //while(end_fin==0){
            //setInterval(function(){
              //endc(this);
              //},1000);
        //}
          //while文で相手のendボタンを待つ
          copy_array();
          end_fin=0;
          if (val.player == 1) {
              duel(instans_card,p2_instans_card);
          }
          //updatefield(field_card, 1);//＊フィールドのｃａｒｄを更新してnullのとこはｃａｒｄがでないようにしたい
          //copy_array(p2_ff_card, copy_card);
          //copy_array(ff_card, copy_card);
          copy_array(ff_card,copy_card);
        }
        ready_flag=0;
        setnum="";
        instanText.setText("");
        count1 = 0;
        count2 = 0;
      }, this);

      function ready_set(){
        if(ready_flag>=1&&ready_flag<4){
          setnum=setnum+" "+set;
          ErrorText.setText("順番:"+setnum);
          ready_flag++;
        }else if(ready_flag>=4){
          ready_flag=1;
          setnum="";
        }
      }

      slime1.on('pointerdown', function (pointer) {
        set = 1;
        ready_set();
      }, this);//場にあるひな形スライムの１個目
      
      slime2.on('pointerdown', function (pointer) {
        set = 2;
        ready_set();
      }, this);

      slime3.on('pointerdown', function (pointer) {
        set = 3;
        ready_set();
      }, this);

      function test(f){
        console.log("TEST:"+f[3].ATK);
      }

      ref.on('pointerdown', function (pointer) {
        //insertHandno(hands, "" + val.player, 0);
        //配列を受け取ってp2_field_cardに入れる
        //for (var i = 1; i <= hand; i++) {
        //  p2_field_card[i] = 'cardh09';//デバッグ
        //  card = this.add.image(-20 + i * 120, height / 8, p2_field_card[i]);
        //  deck = this.add.image(700, height / 8 * 2, 'card');
        //}//p2 hand
        test(instans_card);
        var r1 = Math.floor(Math.random() * 3 + 1);
        console.log("乱数:"+r1);



        var d;
        console.log(d++);
      }, this);//draw　手札上限五枚で五枚以上はドローできない


      draw.on('pointerdown', function (pointer) {
        if (hand < 5) {
          hand++;
          dug++;//掘り進めた数
          card6 = this.add.image(-20 + hand * 120, height / 8 * 7, cards[dug]);
          hands[hand] = cards[dug];
        }
        console.log(field_card[1]);
      }, this);//draw　手札上限五枚で五枚以上はドローできない

    


    function ff_card_type() {
      var str = '' + ff_card[set].NAME;
      if(str.slice(4, 5) == 'c') {
        ff_card[set].TYPE="FLY";
      } else if (str.slice(4, 5) == 'd') {
        ff_card[set].TYPE="PHS";
      } else if (str.slice(4, 5) == 's') {
        ff_card[set].TYPE="MAG";
      } else if (str.slice(4, 5) == 'h') {
        ff_card[set].TYPE="SLI";
      }
    }
    

      function TYPE_CHECK(ty,p){
        if(ty=="MAG"){
          field_card[set]='magic11';
          slime = p.add.image(100 + set * 120, height / 2, 'magic11');
          ErrorText.setText('魔法継承しました');
        }else if(ty=="FLY"){
          field_card[set]='flyic11';
          slime = p.add.image(100 + set * 120, height / 2, 'flyic11');
          ErrorText.setText('飛行継承しました');
        }else if(ty=="PHS"){
          field_card[set]='phsic11';
          slime = p.add.image(100 + set * 120, height / 2, 'phsic11');
          ErrorText.setText('物理継承しました');
        }else{
          field_card[set]='slimc11';
          slime = p.add.image(100 + set * 120, height / 2, 'slimc11');
          ErrorText.setText('パワーアップ');
        }
      }

      function card_deal(po){
        buff();
        if (hands[hand_num] != null && set != null) {
          ff_card[set].NAME = hands[hand_num];
        }
        ff_card_type();
        TYPE_CHECK(ff_card[set].TYPE,po);
        hand--;
        updatehands(hands,hand,hand_num);
        console.log("******typing******");
        console.log(ff_card[set].TYPE);
      }
          

      card5.on('pointerdown', function (pointer) {
        hand_num=5;
        card_deal(this);
      }, this);

      card4.on('pointerdown', function (pointer) {
        hand_num=4;       
        card_deal(this);
      }, this);

      card3.on('pointerdown', function (pointer) {
        hand_num=3;
        card_deal(this);
      }, this);

      card2.on('pointerdown', function (pointer) {
        hand_num=2;
        card_deal(this);
      }, this);

      card1.on('pointerdown', function (pointer) {
        hand_num=1;
        card_deal(this);
      }, this);//一番左出す
    }

  </script>

</body>

</html>
