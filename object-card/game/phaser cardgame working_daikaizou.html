<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Making your first Phaser 3 Game - Part 1</title>
  <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
  <style type="text/css">
    body {
      margin: 0;
    }
  </style>
</head>

<body>

  <script type="text/javascript">

    var config = {
      type: Phaser.AUTO,
      width: 1600,
      height: 800,
      scene: {
        preload: preload,
        create: create,
        update: update
      }
    };

    var field_card={1:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:"スライム"},2:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:"スライム"},3:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:"スライム"}};
    var p2_field_card={1:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},2:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},3:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""}};

    //ff_cardはバフするときの途中に使うやつ
    var ff_card={1:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},2:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},3:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""}};
    var p2_ff_card={1:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},2:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},3:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""}};
    
    //instance_cardは最後のインスタン化するときのやつ
    var instance_card={1:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},2:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},3:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""}};
    var p2_instance_card={1:{HP:2,ATK:2,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},2:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},3:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""}};

    var hands_card={1:{HP:1,ATK:1,TYPE:undefined,NAME:undefined,KIND:"MO"},2:{HP:1,ATK:1,TYPE:undefined,NAME:undefined,KIND:"MO"},3:{HP:1,ATK:1,TYPE:undefined,NAME:undefined,KIND:"MO"},4:{HP:1,ATK:1,TYPE:undefined,NAME:undefined,KIND:"MO"},5:{HP:1,ATK:1,TYPE:undefined,NAME:undefined,KIND:"MO"}};

    var copy_card={1:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},2:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},3:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""}};
    var p2_copy_card={1:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},2:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""},3:{HP:1,ATK:1,SLIME:1,TYPE:"SLIME",FLY:0,PHS:0,MAG:0,NAME:""}};

    var game = new Phaser.Game(config);
    var hand = 3;
    var deck = 30;
    var HP = 10;
    var HPText;
    var set = null;
    var SCText;//場札のどれにsetするかのテキスト
    var WINText;//WINorLOSEのテキスト
    var ErrorText;//Errorのテキスト
    var width = 1600;
    var height = 800;
    var cards = [];
    var dug = hand;
    var count1 = 0;//p1
    var count2 = 0;//p2
    var wins = 0;//連勝数記録
    var STAT_TEXT=[];
    var TYPE_TEXT=[];
    var hands_STAT_TEXT=[];
    var hands_TYPE_TEXT=[];
    var p2_STAT_TEXT=[];
    var p2_TYPE_TEXT=[];
    var end_fin=0;//お互いがend押したかどうか0か1
    var ready_flag=0;//ready押したかどうか
    var set_num="";//どれをインスタンス化するかの数値
    var hand_num=0;//手札の何枚目を場に出したかがわかる数値
    var end_count=0;//
    var vslog_TEXT=[];//iは行
    var p2_vslog_TEXT=[];
    var plog_num=0;//行
    var plog_end=0;
    var objects = {};
    var status_text =[];
    var buffed=0;
    var typs=0;//場札のタイプの数

    function getUrlVars() {
      var vars = [], max = 0, hash = "", array = "";
      var url = window.location.search;

      //?を取り除くため、1から始める。複数のクエリ文字列に対応するため、&で区切る
      hash = url.slice(1).split('&');
      max = hash.length;
      for (var i = 0; i < max; i++) {
        array = hash[i].split('=');    //keyと値に分割。
        vars.push(array[0]);    //末尾にクエリ文字列のkeyを挿入。
        vars[array[0]] = array[1];    //先ほど確保したkeyに、値を代入。
      }

      return vars;
    }
    var val = getUrlVars();
    console.log(val.player);
    var p2_HP=10;

    function preload() {
      this.load.image('card', '/object-cardgame/game/img/card.png');
      this.load.image('card2', '/object-cardgame/game/img/card2.png');
      this.load.image('cardc01', '/object-cardgame/game/img/c01.png');
      this.load.image('cardc02', '/object-cardgame/game/img/c02.png');
      this.load.image('cardc03', '/object-cardgame/game/img/c03.png');
      this.load.image('cardc04', '/object-cardgame/game/img/c04.png');
      this.load.image('cardc05', '/object-cardgame/game/img/c05.png');
      this.load.image('cardc06', '/object-cardgame/game/img/c06.png');
      this.load.image('cardc07', '/object-cardgame/game/img/c07.png');
      this.load.image('cardc08', '/object-cardgame/game/img/c08.png');
      this.load.image('cardc09', '/object-cardgame/game/img/c09.png');
      this.load.image('cardc10', '/object-cardgame/game/img/c10.png');
      this.load.image('cardc11', '/object-cardgame/game/img/c11.png');
      this.load.image('cardc12', '/object-cardgame/game/img/c12.png');
      this.load.image('cardc13', '/object-cardgame/game/img/c13.png');
      this.load.image('cardd01', '/object-cardgame/game/img/d01.png');
      this.load.image('cardd02', '/object-cardgame/game/img/d02.png');
      this.load.image('cardd03', '/object-cardgame/game/img/d03.png');
      this.load.image('cardd04', '/object-cardgame/game/img/d04.png');
      this.load.image('cardd05', '/object-cardgame/game/img/d05.png');
      this.load.image('cardd06', '/object-cardgame/game/img/d06.png');
      this.load.image('cardd07', '/object-cardgame/game/img/d07.png');
      this.load.image('cardd08', '/object-cardgame/game/img/d08.png');
      this.load.image('cardd09', '/object-cardgame/game/img/d09.png');
      this.load.image('cardd10', '/object-cardgame/game/img/d10.png');
      this.load.image('cardd11', '/object-cardgame/game/img/d11.png');
      this.load.image('cardd12', '/object-cardgame/game/img/d12.png');
      this.load.image('cardd13', '/object-cardgame/game/img/d13.png');
      this.load.image('cardh01', '/object-cardgame/game/img/h01.png');
      this.load.image('cardh02', '/object-cardgame/game/img/h02.png');
      this.load.image('cardh03', '/object-cardgame/game/img/h03.png');
      this.load.image('cardh04', '/object-cardgame/game/img/h04.png');
      this.load.image('cardh05', '/object-cardgame/game/img/h05.png');
      this.load.image('cardh06', '/object-cardgame/game/img/h06.png');
      this.load.image('cardh07', '/object-cardgame/game/img/h07.png');
      this.load.image('cardh08', '/object-cardgame/game/img/h08.png');
      this.load.image('cardh09', '/object-cardgame/game/img/h09.png');
      this.load.image('cardh10', '/object-cardgame/game/img/h10.png');
      this.load.image('cardh11', '/object-cardgame/game/img/h11.png');
      this.load.image('cardh12', '/object-cardgame/game/img/h12.png');
      this.load.image('cardh13', '/object-cardgame/game/img/h13.png');
      this.load.image('cards01', '/object-cardgame/game/img/s01.png');
      this.load.image('cards02', '/object-cardgame/game/img/s02.png');
      this.load.image('cards03', '/object-cardgame/game/img/s03.png');
      this.load.image('cards04', '/object-cardgame/game/img/s04.png');
      this.load.image('cards05', '/object-cardgame/game/img/s05.png');
      this.load.image('cards06', '/object-cardgame/game/img/s06.png');
      this.load.image('cards07', '/object-cardgame/game/img/s07.png');
      this.load.image('cards08', '/object-cardgame/game/img/s08.png');
      this.load.image('cards09', '/object-cardgame/game/img/s09.png');
      this.load.image('cards10', '/object-cardgame/game/img/s10.png');
      this.load.image('cards11', '/object-cardgame/game/img/s11.png');
      this.load.image('cards12', '/object-cardgame/game/img/s12.png');
      this.load.image('cards13', '/object-cardgame/game/img/s13.png');
      this.load.image('slimc11', '/object-cardgame/game/img/slime.png');
      this.load.image('magic11', '/object-cardgame/game/img/mag.png');
      this.load.image('magic12', '/object-cardgame/game/img/Rmag.png');
      this.load.image('magic13', '/object-cardgame/game/img/Bmag.png');
      this.load.image('magic14', '/object-cardgame/game/img/Ymag.png');
      this.load.image('phsic11', '/object-cardgame/game/img/phs.png');
      this.load.image('phsic12', '/object-cardgame/game/img/Rphs.png');
      this.load.image('phsic13', '/object-cardgame/game/img/Bphs.png');
      this.load.image('phsic14', '/object-cardgame/game/img/Yphs.png');
      this.load.image('flyic11', '/object-cardgame/game/img/fly.png');
      this.load.image('flyic12', '/object-cardgame/game/img/Rfly.png');
      this.load.image('flyic13', '/object-cardgame/game/img/Bfly.png');
      this.load.image('flyic14', '/object-cardgame/game/img/Yfly.png');
      this.load.image('gree', '/object-cardgame/game/img/green.png');
    }

    function copy_array(c1, c2) {
      for (var i = 1; i <= 3; i++) {
        c1[i].ATK = c2[i].ATK;
        c1[i].HP = c2[i].HP;
        c1[i].NAME = c2[i].NAME;
        console.log("************"+c1[i].NAME);
        c1[i].SLIME= c2[i].SLIME;
        c1[i].FLY= c2[i].FLY;
        c1[i].MAG= c2[i].MAG;
        c1[i].PHS= c2[i].PHS;
        if(c2[i].KIND!=null){
          c1[i].KIND=c2[i].KIND;
        }
      }
    }//前のやつに後ろのやつを入れる

    function hands_kind(s,st){
     var n= Number(st.slice(6,7))
     if(n!=NaN){
      if(n<=9){
        hands_card[s].KIND="OR";
        if(n<=5){
          hands_card[s].KIND="OL";
          if(n<=1){
            hands_card[s].KIND="CP";
          }
        }
      }
     }
    }//OLorORorCPのカードにする　カードの出現率にもなってる

    function hands_status(i){
      var str1 = '' + hands_card[i].NAME;
      console.log(i+"番目のカード:"+str1);
        if (str1.slice(4, 5) == 'c') {
          hands_card[i].ATK = 1;
          hands_card[i].TYPE = "FLY";
          //hands_card[i].NAME ="flyic11";
        } else if (str1.slice(4, 5) == 'd') {
          hands_card[i].ATK = 2;
          hands_card[i].TYPE = "PHS";
          //hands_card[i].NAME = "phsic11";
        } else if (str1.slice(4, 5) == 's') {
          hands_card[i].ATK = 3;
          hands_card[i].TYPE = "MAG";
          //hands_card[i].NAME = "magic11";
        } else if (str1.slice(4, 5) == 'h') {
          hands_card[i].ATK = 4;
          hands_card[i].TYPE = "FLY";
          //hands_card[i].NAME = "slimc11";
        }
        if(hands_card[i].KIND=="MO"){
          hands_card[i].HP = Number(2);
        }else{
          hands_card[i].HP = Number(str1.slice(6, 7));
        }
      if(hands_card[i].NAME!=null){
        hands_STAT_TEXT[i].setText(hands_card[i].ATK+":"+hands_card[i].HP);//Errorはいてます
        if(hands_card[i].KIND=="MO"){
          hands_TYPE_TEXT[i].setText(hands_card[i].NAME);
        }else{
          hands_TYPE_TEXT[i].setText(hands_card[i].TYPE);
        }
      }
    }

    function status_card(po){
      for(var i=1;i<=5;i++){
        hands_STAT_TEXT[i] = po.add.text(-40 + i * 120, height / 8 * 7+50, "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
        hands_STAT_TEXT[i].setText("");
        hands_TYPE_TEXT[i] = po.add.text(-30 + i * 120-25, height / 8 * 7-75, "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
        hands_TYPE_TEXT[i].setText("");
        hands_status(i);
      }
    }//手札のカードの値をカードの下に表示する？？

    function type_print(a){
      //console.log("TYPE_PRINT:"+a.NAME);
      if(a.NAME==null){
        return "gree";
      }
      if(a.NAME!=null){
        if(a.TYPE=="SLIME"){
          return "slimc11";
        }else if(a.TYPE=="FLY"){
          if(a.KIND=="OL"){
            return "flyic12";
          }else if(a.KIND=="OR"){
            return "flyic13";
          }else if(a.KIND=="CP"){
            return "flyic14";
          }
          return "flyic11";
        }else if(a.TYPE=="MAG"){
          if(a.KIND=="OL"){
            return "magic12";
          }else if(a.KIND=="OR"){
            return "magic13";
          }else if(a.KIND=="CP"){
            return "magic14";
          }
          return "magic11";
        }else if(a.TYPE=="PHS"){
          if(a.KIND=="OL"){
            return "phsic12";
          }else if(a.KIND=="OR"){
            return "phsic13";
          }else if(a.KIND=="CP"){
            return "phsic14";
          }
          return "phsic11";
        }
      }else{
        return "gree";
      }
    }

    function create() {
      objects.camera = this.cameras.add(0, 0, 1600, 800);//どっからどこまでカメラ
      objects.camera.setBackgroundColor('rgba(0,255,0, 0.5)');//背景色を帰れるよ
      
      var x = 0;

      for (var i = 1; i <= 9; i++) {
        cards[x] = 'cardc0' + i;
        x++;
        cards[x] = 'cardd0' + i;
        x++;
        cards[x] = 'cardh0' + i;
        x++;
        cards[x] = 'cards0' + i;
        x++;
      }//make deck1

      for (var i = 10; i <= 13; i++) {
        cards[x] = 'cardc' + i;
        x++;
        cards[x] = 'cardd' + i;
        x++;
        cards[x] = 'cardh' + i;
        x++;
        cards[x] = 'cards' + i;
        x++;
      }//make deck2

      for (i = 1; i <= 52; i++) {
        r = Math.floor(Math.random() * 13 * 4);
        w = cards[i];
        cards[i] = cards[r];
        cards[r] = w;
      }//shuffle

      function monster_card(thas){
        var monster={1:{HP:1,ATK:1,TYPE:"SLIME",NAME:"RED",KIND:"MO"},2:{HP:1,ATK:1,TYPE:"SLIME",NAME:"GREEN",KIND:"MO"},3:{HP:1,ATK:1,TYPE:"SLIME",NAME:"BLUE",KIND:"MO"}};
        for(var i=1;i<=hand;i++){
          hands_card[i]=monster[i];
          card = thas.add.image(-20 + i * 120, height / 8 * 7, type_print(hands_card[i]));
        }
      }

      monster_card(this);
      status_card(this);

      for(var i=1;i<=3;i++){
        STAT_TEXT[i] = this.add.text(180*i-45, 450, "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
        TYPE_TEXT[i] = this.add.text(180*i-45, 325, "").setFontSize(20).setFontFamily("Arial").setOrigin(0).setInteractive();
        field_card[i].SLIME=1;
        //field_card[i].NAME="slimc11";
        p2_field_card[i].SLIME = 1;
        p2_field_card[i].NAME = "スライム";
        STAT_TEXT[i].setText(ff_card[i].ATK+":"+ff_card[i].HP);
        TYPE_TEXT[i].setText(field_card[i].NAME);//動くの？？
        p2_STAT_TEXT[i] = this.add.text(80 + i * 120, 150, "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
        p2_TYPE_TEXT[i] = this.add.text(80 + i * 120-25, 25, "").setFontSize(20).setFontFamily("Arial").setOrigin(0).setInteractive();
        p2_STAT_TEXT[i].setText(p2_ff_card[i].ATK+":"+p2_ff_card[i].HP);
        p2_TYPE_TEXT[i].setText(p2_field_card[i].NAME);
      }//typeと数値を出すp1とp2 場札

      deck = this.add.image(700, height / 8 * 2, 'card');
      text = this.add.text(680, 150, '山札');

      SCText = this.add.text(300, 250, 'SET:' + set).setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
      p2_HPText = this.add.text(650, 300, '2P HP:' + p2_HP).setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();      
      HPText = this.add.text(650, 450, '1P HP:' + HP).setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
      WINText = this.add.text(450, 250, '').setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
      ErrorText = this.add.text(200, 550, '').setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
      instanText = this.add.text(100, 500, '').setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
    }

    function result(count1, count2) {
      if (count2>count1) {
        if (wins >= 1) {
          wins++;
          WINText.setText('WINS:' + wins);
        } else {
          wins = 1;
          WINText.setText('WIN');
        }
        p2_HP--;
        if(p2_HP==1){
          ErrorText.setText('YOU WIN');
        }
      } else if (count1>count2) {
        WINText.setText('LOSE');
        if (HP == 1) {
          ErrorText.setText('YOU LOSE');  
        }
        HP -= 1;
      } else {
        WINText.setText('Draw');
      }
      HPText.setText('1P HP' + HP);
      p2_HPText.setText('2P HP'+p2_HP);
    }

    function print_log_ref(){
        for(var i=1;i<plog_num;i++){
          vslog_TEXT[i].setText("");
        }
        plog_num=0;
    }

    function p2_print_log(po){
      if(plog_end==1){
        print_log_ref();
        plog_end=0;
      }
      for(i=0;i<=5;i++){
        vslog_TEXT[plog_num] = po.add.text(900, height / 8+50*plog_num , "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
        vslog_TEXT[plog_num].setText(p2_vslog_TEXT[plog_num]);
        plog_num++;
      }
      }//戦闘のログを実際に画面に表示する？

    function print_log(po,r1,r2,k,a,c){
      if(plog_end==1){
        print_log_ref();
        plog_end=0;
      }
        vslog_TEXT[plog_num] = po.add.text(900, height / 8+50*plog_num , "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive();
        p2_vslog_TEXT[plog_num]="p1の"+copy_card[r1].TYPE+"["+copy_card[r1].HP+":"+copy_card[r1].ATK+"] VS p2の"+p2_copy_card[r2].TYPE+"["+p2_copy_card[r2].HP+":"+p2_copy_card[r2].ATK+"]";
        vslog_TEXT[plog_num].setText(p2_vslog_TEXT[plog_num]);
        console.log("****************"+p2_vslog_TEXT[plog_num]);
        plog_num++;
        if(k==1){
          vslog_TEXT[plog_num] = po.add.text(900, height / 8+50*plog_num , "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive().setFill("white");
          p2_vslog_TEXT[plog_num]="引き分け";
          vslog_TEXT[plog_num].setText(p2_vslog_TEXT[plog_num]);
        }else if(k==2){
          vslog_TEXT[plog_num] = po.add.text(900, height / 8+50*plog_num  , "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive().setFill("blue");
          p2_vslog_TEXT[plog_num]="p2の"+p2_copy_card[r2].TYPE+"["+p2_copy_card[r2].HP+":"+p2_copy_card[r2].ATK+"]の勝利";
          vslog_TEXT[plog_num].setText(p2_vslog_TEXT[plog_num]);
        }else if(k==3){
          vslog_TEXT[plog_num] = po.add.text(900, height / 8+50*plog_num  , "").setFontSize(30).setFontFamily("Arial").setOrigin(0).setInteractive().setFill("red");
          p2_vslog_TEXT[plog_num]="p1の"+copy_card[r1].TYPE+"["+copy_card[r1].HP+":"+copy_card[r1].ATK+"]の勝利";
          vslog_TEXT[plog_num].setText(p2_vslog_TEXT[plog_num]);
        }
        //updateLog(p2_vslog_TEXT);
        plog_num++;
      }//戦闘のログを実際に画面に表示する？
    
    var attack=function(a,b){
      return a-b;
    }

    var deffence=function(a,b,d){
      if(a!=b){
        return d;
      }else{
        return 0;
      }
    }

    function duel(f, p2_f,po) {
      var cnum=0;
      while ((count1 != 3  && count2 != 3)&& cnum++ != 30) {
        var r1 = Math.floor(Math.random() * 3 + 1);
        var r2 = Math.floor(Math.random() * 3 + 1);
        if (f[r1].HP > 0 && p2_f[r2].HP > 0) {
            console.log("f["+r1+"]"+"VS"+"p2_f["+r2+"]");
            // var damage=attack(f[r1].HP,p2_f[r2].ATK);
            // f[r1].HP-=deffence(f[r1].TYPE,p2_f[r2].TYPE,damage);
            
            // var damage=attack(p2_f[r2].HP,f[r1].ATK);
            // p2_f[r2].HP-=deffence(f[r1].TYPE,p2_f[r2].TYPE,damage);
            if(f[r1].TYPE!=p2_f[r2].TYPE){
              f[r1].HP-=p2_f[r2].ATK;
              p2_f[r2].HP-=f[r1].ATK;
            }
            
            if(f[r1].HP <= 0 && p2_f[r2].HP <= 0){
              console.log("Draw");
              count1++;
              count2++; 
              print_log(po,r1,r2,1,f,p2_f);
            }else{
              if (f[r1].HP <= 0) {
                count1++;//カードが倒されたp1の
                console.log("p2_f["+r2+"]の勝利");
                print_log(po,r1,r2,2,f,p2_f);
              } 
              if (p2_f[r2].HP <= 0) {
                count2++;//カードが倒されたp2の
                console.log("f["+r1+"]の勝利");
                print_log(po,r1,r2,3,f,p2_f);
              }
            }
        }
        console.log('count1:' + count1);
        console.log('count2:' + count2);
      }
      result(count1, count2);
    }//p1からp2への戦い一方的
    //今p2の場札1を1.1じゃなくて2.2にしてるよ
    

    function buff(){
      console.log("もとのやつ:"+ff_card[set].ATK+","+ff_card[set].HP);
      console.log("足した奴:"+hands_card[hand_num].ATK+","+hands_card[hand_num].HP);
      ff_card[set].ATK+=hands_card[hand_num].ATK;
      ff_card[set].HP+=hands_card[hand_num].HP;
      console.log("ATK合計:"+ff_card[set].ATK);
      console.log("HP合計:"+ff_card[set].HP);
    }

    

    function overload(){
      if(hands_card[hand_num].TYPE=="FLY"){
        field_card[set].FLY=1;
      }else if(hands_card[hand_num].TYPE=="MAG"){
        field_card[set].MAG=1;
      }else if(hands_card[hand_num].TYPE=="PHS"){
        field_card[set].PHS=1;
      }else if(hands_card[hand_num].TYPE=="SLIME"){
        field_card[set].SLIME=1;
      }
    }//オーバーロードカードの動き

    function override(){
      if(hands_card[hand_num].TYPE==field_card[set].TYPE){
        field_card[set].HP*=2;
        ff_card[set].HP*=2;
        ErrorText.setText('オーバーライドしました');
        return 1;
      }else{
        return 0;
      }
    }

    function capsule(){
      if(hands_card[hand_num].TYPE=="FLY"){
        ff_card[set].FLY=0;
      }else if(hands_card[hand_num].TYPE=="MAG"){
        ff_card[set].MAG=0;
      }else if(hands_card[hand_num].TYPE=="PHS"){
        ff_card[set].PHS=0;
      }else if(hands_card[hand_num].TYPE=="SLIME"){
        ff_card[set].SLIME=0;
      }
    }

    function inheri_check(){
      if(field_card[set].NAME=="GREENスライム"){
        return 1;
      }else if(field_card[set].NAME=="REDスライム"){
        return 1;
      }else if(field_card[set].NAME=="BLUEスライム"){
        return 1;
      }else{
        return 0;
      }
    }

    function replen_card(p){
        for(var i=hand+1;i<=5;i++){
          dug++;//掘り進めた数
          hands_card[i].NAME=''+String(cards[dug]);
          hands_kind(i,hands_card[i].NAME);
          hands_status(i);
          card6 = p.add.image(-20 + hand * 120, height / 8 * 7, type_print(hands_card[i]));
        }
        console.log(hands_card[hand]);
    }//カードの補充

    function update() {
      let draw = this.add.text(800, 400, 'Draw').setFontSize(30).setFontFamily("Arial").setOrigin(0.5).setInteractive();
      let end = this.add.text(700, 400, 'End').setFontSize(30).setFontFamily("Arial").setOrigin(0.5).setInteractive();
      let ready = this.add.text(150, 300, 'インスタンス').setFontSize(30).setFontFamily("Arial").setOrigin(0.5).setInteractive();
      let card1 = this.add.image(100, height / 8 * 7, type_print(hands_card[1])).setOrigin(0.5).setInteractive();
      let card2 = this.add.image(220, height / 8 * 7, type_print(hands_card[2])).setOrigin(0.5).setInteractive();
      let card3 = this.add.image(340, height / 8 * 7, type_print(hands_card[3])).setOrigin(0.5).setInteractive();
      let card4 = this.add.image(460, height / 8 * 7, type_print(hands_card[4])).setOrigin(0.5).setInteractive();
      let card5 = this.add.image(580, height / 8 * 7, type_print(hands_card[5])).setOrigin(0.5).setInteractive();
      var slime1 = this.add.image(160, height / 2, type_print(field_card[1])).setInteractive();
      var slime2 = this.add.image(340, height / 2, type_print(field_card[2])).setInteractive();
      var slime3 = this.add.image(520, height / 2, type_print(field_card[3])).setInteractive();
      let p2_ff_card1 = this.add.image(-20 + 2 * 120, height / 8, type_print(p2_field_card[1])).setInteractive();
      let p2_ff_card2 = this.add.image(-20 + 3 * 120, height / 8, type_print(p2_field_card[2])).setInteractive();
      let p2_ff_card3 = this.add.image(-20 + 4 * 120, height / 8, type_print(p2_field_card[3])).setInteractive();
      SCText.setText('SET:' + set);//出したいカードの場所テキスト
      deck = this.add.image(700, height / 8 * 6, 'card').setInteractive();//山札クリックしてもドローできるよ
      text = this.add.text(680, 550, '山札');
      
      function p2_stat_update(){
        for(i=1;i<=3;i++){
          p2_STAT_TEXT[i].setText(p2_ff_card[i].ATK+":"+p2_ff_card[i].HP);
          p2_TYPE_TEXT[i].setText(p2_ff_card[i].TYPE);
        }//p2 dbから帰ってきたようのやつ
      }

      function update_hands() {
        hand--;
        for (var i = hand_num; i <= hand; i++) {
          hands_card[i].NAME = hands_card[i + 1].NAME;
          hands_status(i);
        }
        //hands_card[hand+1].NAME="gree";
        hands_STAT_TEXT[hand+1].setText("");
        hands_TYPE_TEXT[hand+1].setText("");
        hands_card[hand+1].NAME=null;
        STAT_TEXT[set].setText(ff_card[set].ATK+":"+ff_card[set].HP);
        TYPE_TEXT[set].setText(field_card[set].NAME);
        console.log(hands_card);
      }//手札の順番ソート

      function inheri(){
        buff();
        buffed=1;
        field_card[set].NAME = hands_card[hand_num].NAME+field_card[set].NAME;
        update_hands();
      }//継承
      

      function instance(str){
        j=1;
        for(var i=2;i<=6;i=i+2){
          instance_card[j]=ff_card[str.slice(i-1,i)];
          console.log("strslice"+i+":"+str.slice(i-1,i));
          j++;
        }
      }

      function print(){
        for(i=1;i<=3;i++){
        console.log("f1["+i+":"+ff_card[i].HP+":"+ff_card[i].ATK);
        console.log("f2["+i+":"+p2_ff_card[i].HP+":"+p2_ff_card[i].ATK);
        console.log("instance_Card["+i+"]:"+instance_card[i].HP+":"+instance_card[i].ATK);
        console.log("p2_instance_Card["+i+"]:"+p2_instance_card[i].HP+":"+p2_instance_card[i].ATK);
        }
      }

      function refresh(){
        ready_flag=0;
        set_num="";
        instanText.setText("");
        count1 = 0;
        count2 = 0;
        plog_end=1;
      }

      function ready_set(){
        if(ready_flag>=1&&ready_flag<4){
          set_num=set_num+" "+set;
          ErrorText.setText("順番:"+set_num);
          ready_flag++;
        }else if(ready_flag>=4){
          ready_flag=1;
          set_num="";
          ErrorText.setText("順番:"+set_num);
        }
      }

      function TYPE_CHECK(ty,p){
        var t="";
        if(ty=="MAG"){
          //field_card[set].NAME='magic11';
          field_card[set].MAG = 1;
          ff_card[set].MAG = 1;
          t+="魔法";
          //ErrorText.setText('魔法継承しました');
        }else if(ty=="FLY"){
          //field_card[set].NAME='flyic11';
          field_card[set].FLY=1;
          ff_card[set].FLY = 1;
          t+="飛行";
          //ErrorText.setText('飛行継承しました');
        }else if(ty=="PHS"){
          //field_card[set].NAME='phsic11';
          field_card[set].PHS=1;
          ff_card[set].PHS = 1;
          t+="物理";
          //ErrorText.setText('物理継承しました');
        }
        ErrorText.setText(t+'をオーバーロードしました');
      }

      function card_deal(po){
        if(set!=null && hands_card[hand_num].NAME!="gree" && hands_card[hand_num].NAME!=null){
          var okor=1;
          if(inheri_check()==1){
            if(hands_card[hand_num].KIND=="CP"){
              capsule();
            }else{
              if(hands_card[hand_num].KIND=="OL"){
                field_card[set].TYPE = hands_card[hand_num].TYPE;
                overload();
                TYPE_CHECK(field_card[set].TYPE,po);
              }else if(hands_card[hand_num].KIND=="OR"){
                if(okor=override()){
                  field_card[set].TYPE = hands_card[hand_num].TYPE;
                }
              }
              if(okor==1){
                buff();
                buffed=1;
                ff_card[set].TYPE = hands_card[hand_num].TYPE;
                update_hands();
              }else{
                ErrorText.setText('タイプが違うと,オーバーロードできません');
              }
            } 
          }else if(hands_card[hand_num].KIND=="MO"){
            inheri();
          }else if(hands_card[hand_num].KIND!="MO"){
            ErrorText.setText('継承していないとオーバーライド,オーバーロードできません');
          }
        }else if(set==null){
          ErrorText.setText("場にある継承元を選んでください");
        }
      }

      function print_type_text(){
        typs=0;
        if(field_card[set].SLIME==1){
          typs++;
          if(field_card[set].FLY==1){
            typs++;
          }
          if(field_card[set].MAG==1){
            typs++
          }
          if(field_card[set].PHS==1){
            typs++;
          }
        }
      }

      function status_log(pa){
        var check_card=[];
        var c=hand_num;
        if(status_text[0]!=null){
          for(var i=0;i<=typs*2;i++){
            status_text[i].setText("");
          }
        }//reset status_log
        var i=0;
        if(status_text[i]!=null&&c!=0){
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("継承:"+field_card[set].NAME+"("+ff_card[set].TYPE+")<-"+copy_card[set].NAME+"("+copy_card[set].TYPE+")");
          i++;
        }else{
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("継承:"+field_card[set].NAME+"("+field_card[set].TYPE+")");
          i++;
        }
        print_type_text();
        if(ff_card[set].SLIME==1){
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("int attack(SLIME)");
          i++;
        }
        if(ff_card[set].FLY==1){
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("int attack(FLY)");
          i++;
        }
        if(ff_card[set].MAG==1){
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("int attack(MAG)");
          i++;
        }
        if(ff_card[set].PHS==1){
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("int attack(PHS)");
          i++;
        }
        if(ff_card[set].SLIME==1){
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("int deffence(SLIME)");
          i++;
        }
        if(ff_card[set].FLY==1){
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("int deffence(FLY)");
          i++;
        }
        if(ff_card[set].MAG==1){
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("int deffence(MAG)");
          i++;
        }
        if(ff_card[set].PHS==1){
          status_text[i]=pa.add.text(900,height/2+40*i,"").setInteractive();
          status_text[i].setText("int deffence(PHS)");
          i++;
        }
      }//beta status_log

      


      ready.on('pointerdown', function (pointer) {
        instanText.setText("どれを戦闘に参加させますか？(インスタンス化)");
        ErrorText.setText("順番:"+set_num);
        ready_flag=1;
      }, this);

      end.on('pointerdown', function (pointer) {
        console.log("end:"+field_card);
        if(ready_flag!=4){
          ErrorText.setText("Instanceを押してインスタンス化してください");
        } else {
          instance(set_num);
          console.log("instance_card:"+instance_card);
          print();
          copy_array(copy_card,ff_card);
          copy_array(p2_copy_card,p2_instance_card);
          console.log("p2" + p2_field_card);
          console.log("p1" + instance_card);
          end_fin=0;
          if (val.player == 1) {
              duel(instance_card,p2_instance_card,this);
          }
          copy_array(ff_card,copy_card);
          copy_array(p2_instance_card,p2_copy_card);
        }
        refresh();
      }, this);
          
      slime1.on('pointerdown', function (pointer) {
        set = 1;
        ready_set();
        if(buffed==0){
        copy_array(copy_card,field_card);
        console.log("++++++++copyed");
        }
        status_log(this);
      }, this);//場にあるひな形スライムの１個目
      
      slime2.on('pointerdown', function (pointer) {
        set = 2;
        ready_set();
        if(buffed==0){
        copy_array(copy_card,field_card);
        console.log("++++++++copyed");
        }
        status_log(this);
      }, this);

      slime3.on('pointerdown', function (pointer) {
        set = 3;
        ready_set();
        if(buffed==0){
        copy_array(copy_card,field_card);
        console.log("++++++++copyed");
        }
        status_log(this);
      }, this);

      draw.on('pointerdown', function (pointer) {
        if (hand < 5) {
          hand++;
          dug++;//掘り進めた数
          hands_card[hand].NAME=''+String(cards[dug]);
          hands_kind(hand,hands_card[hand].NAME);
          hands_status(hand);
          card6 = this.add.image(-20 + hand * 120, height / 8 * 7, type_print(hands_card[hand]));
        }
        console.log(hands_card[hand]);
      }, this);//draw　手札上限五枚で五枚以上はドローできない   
      
      deck.on('pointerdown', function (pointer) {
        if (hand < 5) {
          replen_card(this);
        }
        console.log(field_card[1]);
      }, this);//draw　手札上限五枚で五枚以上はドローできない  

      card5.on('pointerdown', function (pointer) {
        hand_num=5;
        card_deal(this);
      }, this);

      card4.on('pointerdown', function (pointer) {
        hand_num=4;       
        card_deal(this);
      }, this);

      card3.on('pointerdown', function (pointer) {
        hand_num=3;
        card_deal(this);
      }, this);

      card2.on('pointerdown', function (pointer) {
        hand_num=2;
        card_deal(this);
      }, this);

      card1.on('pointerdown', function (pointer) {
        hand_num=1;
        card_deal(this);
      }, this);//一番左出す
    }

  </script>

</body>

</html>